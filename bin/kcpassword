#!/usr/bin/env ruby

require 'rubygems'
require 'methadone'
require 'app_tools/version'
require 'fileutils'

module AppTools
  module KcPassword
    include Methadone::Main
    include Methadone::CLILogging
    include Methadone::ExitNow

    main do
      itunes_password = options[:p]
      itunes_user = options[:u]

      name = "app-tools - iTunesConnect - #{itunes_user}"

      if options[:delete]
        pid = Process.spawn('security', 'delete-generic-password', '-a', itunes_user, '-s', name)
        Process.wait pid
        if $?.exitstatus == 0
          info "Deleted generic password '#{name}'"
        else
          error "Could not find generic password '#{name}'"
        end
      elsif
        if itunes_password.nil?
          puts 'Password:'
          itunes_password = STDIN.noecho(&:get).chomp
        end

        pid = Process.spawn('security', 'find-generic-password', '-a', itunes_user, '-s', name)

        IO.popen(['security', 'add-generic-password', '-a', itunes_user, '-s', name])
      end
    end

    description 'kcpassword - Adds or removes a generic keychain password for use by app-tools'
    version AppTools::VERSION

    on("-d", "--delete", "Delete a password entry instead of creating it")
    on("-u", "--itunes-user ITUNES_USER", "iTunesConnect user", :required)
    on("-p", "--itunes-password ITUNES_PASSWORD", "iTunesConnect password")

    use_log_level_option :toggle_debug_on_signal => 'USR1'

    go!
  end
end
