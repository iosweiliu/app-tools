#!/usr/bin/env ruby

require 'rubygems'
require 'methadone'
require 'app_tools/version'
require 'fileutils'
require 'spaceship'

#
# This project is an extraction and rewrite in Ruby of
# https://github.com/drewcrawford/CaveJohnson/blob/master/cavejohnson/__init__.py#L122
#

module AppTools
  module SyncPp
    include Methadone::Main
    include Methadone::CLILogging
    include Methadone::ExitNow

    def self.keep_trying
      tries ||= 5
      yield
    rescue UnexpectedResponse
      sleep 3
      retry unless (tries -= 1).zero?
    end

    main do |profile_name|
      itunes_user = options[:u]
      itunes_password = options[:p]
      keychain_name = "app-tools/iTunesConnect - #{itunes_user}"

      if itunes_user.nil?
        exit_now! "Must supply a user name"
      end

      if itunes_password.nil?
        r, w = IO.pipe
        pid = Process.spawn('security', 'find-generic-password', '-s', keychain_name, '-w', :out => w)
        w.close
        Process.wait(pid)
        if $?.exitstatus != 0
          exit_now! "Could not find generic password '#{keychain_name}'"
        end
        itunes_password = r.read.chomp
        r.close
      end

      if itunes_password.nil?
        exit_now! "No password given and non found in keychain"
      end

      Spaceship.login(itunes_user, itunes_password)

      profile = nil

      # NOTE: Sometimes the call to the Apple API can fail, hence the retries

      # Get the provisioning profile that matches the name given
      keep_trying do
        profiles = Spaceship.provisioning_profile.all
        profile = profiles.find do |profile|
          profile.name == profile_name
        end
      end

      if profile.nil?
        exit_now! "Provisioning profile '#{profile_name}' not found"
      end

      # If it's not valid, repair it now, i.e. get it re-issued.
      unless profile.valid?
        profile = profile.repair!
      end

      # Get the profile certificate that matches the profile type
      profile_cert = profile.certificates.find do |cert|
        cert.name == profile.type
      end

      # Get the full certificate record
      cert = nil
      keep_trying do
        certs = Spaceship.certificate.all
        cert = certs.find do |cert|
          cert.id == profile_cert.id
        end
      end

      profile_path = "#{profile_name}.mobileprovision"

      File.write(profile_path, profile.download)

      puts cert.name
    end

    description 'syncpp - Synchronize a certificate and provisioning profile'
    version AppTools::VERSION

    on("-u", "--itunes-user USER", "iTunesConnect user")
    on("-p", "--itunes-password PASSWORD", "iTunesConnect password")

    arg :profile_name, "Profile name", :required

    use_log_level_option :toggle_debug_on_signal => 'USR1'

    go!
  end
end
